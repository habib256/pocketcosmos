<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Int√©gration IA - Rocket Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        .success { border-left-color: #51cf66; }
        .error { border-left-color: #ff6b6b; }
        .warning { border-left-color: #ffd43b; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.ok { background: #51cf66; color: black; }
        .status.fail { background: #ff6b6b; color: white; }
        .status.pending { background: #ffd43b; color: black; }
        .code-block {
            background: #0d1117;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        button {
            background: #4a90e2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5ba0f2;
        }
    </style>
</head>
<body>
    <h1>ü§ñ Test d'Int√©gration IA - Corrections Appliqu√©es</h1>

    <div class="test-section">
        <h2>1. Test de Chargement des D√©pendances</h2>
        <div id="dependencies-tests"></div>
    </div>

    <div class="test-section">
        <h2>2. Test des Constantes Corrig√©es</h2>
        <div id="constants-tests"></div>
    </div>

    <div class="test-section">
        <h2>3. Test d'Initialisation RocketAI</h2>
        <div id="rocketai-tests"></div>
        <button onclick="testRocketAIInitialization()">üöÄ Tester RocketAI</button>
    </div>

    <div class="test-section">
        <h2>4. Test HeadlessRocketEnvironment</h2>
        <div id="environment-tests"></div>
        <button onclick="testHeadlessEnvironment()">üåç Tester Environnement</button>
    </div>

    <div class="test-section">
        <h2>5. Test TrainingOrchestrator</h2>
        <div id="training-tests"></div>
        <button onclick="testTrainingOrchestrator()">üéØ Tester Orchestrateur</button>
    </div>

    <div class="test-section">
        <h2>6. Test d'Entra√Ænement Rapide</h2>
        <div id="quick-training-tests"></div>
        <button onclick="runQuickTrainingTest()">‚ö° Test Entra√Ænement Rapide</button>
    </div>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0/dist/tf.min.js"></script>
    
    <!-- Matter.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/matter-attractors@0.1.6/build/matter-attractors.min.js"></script>
    
    <!-- D√©pendances du projet dans l'ordre corrig√© -->
    <script src="constants.js"></script>
    <script src="EventTypes.js"></script>
    
    <!-- Mod√®les -->
    <script src="models/UniverseModel.js"></script>
    <script src="models/CelestialBodyModel.js"></script>
    <script src="models/RocketModel.js"></script>
    <script src="models/CameraModel.js"></script>
    <script src="models/ParticleModel.js"></script>
    <script src="models/ParticleSystemModel.js"></script>

    <!-- Contr√¥leurs -->
    <script src="controllers/EventBus.js"></script>
    <script src="controllers/BodyFactory.js"></script>
    <script src="controllers/CollisionHandler.js"></script>
    <script src="controllers/ThrusterPhysics.js"></script>
    <script src="controllers/SynchronizationManager.js"></script>
    <script src="controllers/PhysicsVectors.js"></script>
    <script src="controllers/PhysicsController.js"></script>
    <script src="controllers/InputController.js"></script>
    <script src="controllers/CameraController.js"></script>
    <script src="controllers/RenderingController.js"></script>
    <script src="controllers/ParticleController.js"></script>
    <script src="controllers/RocketController.js"></script>
    <script src="controllers/MissionManager.js"></script>
    <script src="controllers/RocketCargo.js"></script>
    <script src="controllers/CelestialBodyFactory.js"></script>
    <script src="controllers/ControllerContainer.js"></script>
    
    <!-- Scripts IA dans l'ordre corrig√© -->
    <script src="controllers/RocketAI.js"></script>
    <script src="controllers/HeadlessRocketEnvironment.js"></script>
    <script src="controllers/TrainingOrchestrator.js"></script>
    <script src="train.js"></script>

    <script>
        // Initialiser ControllerContainer global
        if (typeof ControllerContainer !== 'undefined') {
            window.controllerContainer = new ControllerContainer();
        }

        // Initialiser Matter Attractors
        try {
            Matter.use(MatterAttractors);
            console.log('‚úÖ Matter Attractors initialis√©');
        } catch (e) {
            console.error('‚ùå Erreur Matter Attractors:', e);
        }

        function addTestResult(containerId, testName, status, details = '') {
            const container = document.getElementById(containerId);
            const statusClass = status === 'OK' ? 'ok' : status === 'FAIL' ? 'fail' : 'pending';
            
            const testDiv = document.createElement('div');
            testDiv.style.margin = '10px 0';
            testDiv.innerHTML = `
                <span class="status ${statusClass}">${status}</span>
                <strong>${testName}</strong>
                ${details ? `<br><small style="color: #888;">${details}</small>` : ''}
            `;
            container.appendChild(testDiv);
        }

        // Test 1: D√©pendances
        function testDependencies() {
            const tests = [
                { name: 'TensorFlow.js', test: () => typeof tf !== 'undefined' },
                { name: 'Matter.js', test: () => typeof Matter !== 'undefined' },
                { name: 'EventBus', test: () => typeof EventBus !== 'undefined' },
                { name: 'RocketAI', test: () => typeof RocketAI !== 'undefined' },
                { name: 'HeadlessRocketEnvironment', test: () => typeof HeadlessRocketEnvironment !== 'undefined' },
                { name: 'TrainingOrchestrator', test: () => typeof TrainingOrchestrator !== 'undefined' }
            ];

            tests.forEach(({ name, test }) => {
                try {
                    const result = test();
                    addTestResult('dependencies-tests', name, result ? 'OK' : 'FAIL');
                } catch (e) {
                    addTestResult('dependencies-tests', name, 'FAIL', `Erreur: ${e.message}`);
                }
            });
        }

        // Test 2: Constantes
        function testConstants() {
            const tests = [
                { name: 'ROCKET.FUEL_MAX', test: () => typeof ROCKET !== 'undefined' && typeof ROCKET.FUEL_MAX === 'number' },
                { name: 'ROCKET.THRUSTER_POWER', test: () => typeof ROCKET !== 'undefined' && typeof ROCKET.THRUSTER_POWER === 'object' },
                { name: 'PHYSICS.G', test: () => typeof PHYSICS !== 'undefined' && typeof PHYSICS.G === 'number' },
                { name: 'window.EVENTS.AI', test: () => typeof window.EVENTS !== 'undefined' && typeof window.EVENTS.AI === 'object' }
            ];

            tests.forEach(({ name, test }) => {
                try {
                    const result = test();
                    addTestResult('constants-tests', name, result ? 'OK' : 'FAIL');
                } catch (e) {
                    addTestResult('constants-tests', name, 'FAIL', `Erreur: ${e.message}`);
                }
            });

            // Test sp√©cifique pour FUEL_CAPACITY (ne devrait pas exister)
            if (typeof ROCKET !== 'undefined' && typeof ROCKET.FUEL_CAPACITY !== 'undefined') {
                addTestResult('constants-tests', 'ROCKET.FUEL_CAPACITY supprim√©', 'FAIL', 'Cette constante devrait √™tre supprim√©e');
            } else {
                addTestResult('constants-tests', 'ROCKET.FUEL_CAPACITY supprim√©', 'OK', 'Constante correctement supprim√©e');
            }
        }

        // Test 3: RocketAI
        function testRocketAIInitialization() {
            try {
                const eventBus = new EventBus();
                const rocketAI = new RocketAI(eventBus);
                
                addTestResult('rocketai-tests', 'Cr√©ation RocketAI', 'OK');
                
                // Test des m√©thodes critiques
                const methods = ['checkDependencies', 'buildState', 'calculateReward', 'injectDependencies'];
                methods.forEach(method => {
                    if (typeof rocketAI[method] === 'function') {
                        addTestResult('rocketai-tests', `M√©thode ${method}`, 'OK');
                    } else {
                        addTestResult('rocketai-tests', `M√©thode ${method}`, 'FAIL', 'M√©thode manquante');
                    }
                });

                // Test buildState avec donn√©es nulles
                const state = rocketAI.buildState();
                if (Array.isArray(state) && state.length === 10) {
                    addTestResult('rocketai-tests', 'buildState (donn√©es nulles)', 'OK', 'Retourne un √©tat par d√©faut');
                } else {
                    addTestResult('rocketai-tests', 'buildState (donn√©es nulles)', 'FAIL', '√âtat invalide');
                }

                // Test calculateReward avec donn√©es nulles
                const reward = rocketAI.calculateReward();
                if (typeof reward === 'number' && isFinite(reward)) {
                    addTestResult('rocketai-tests', 'calculateReward (donn√©es nulles)', 'OK', `R√©compense: ${reward}`);
                } else {
                    addTestResult('rocketai-tests', 'calculateReward (donn√©es nulles)', 'FAIL', 'R√©compense invalide');
                }

            } catch (e) {
                addTestResult('rocketai-tests', 'Initialisation RocketAI', 'FAIL', `Erreur: ${e.message}`);
            }
        }

        // Test 4: HeadlessRocketEnvironment
        function testHeadlessEnvironment() {
            try {
                const config = {
                    maxStepsPerEpisode: 100,
                    rocketInitialState: {
                        position: { x: 0, y: 0 },
                        velocity: { x: 0, y: 0 },
                        fuel: ROCKET.FUEL_MAX,
                        health: 100
                    }
                };
                
                const env = new HeadlessRocketEnvironment(config);
                addTestResult('environment-tests', 'Cr√©ation HeadlessRocketEnvironment', 'OK');

                // Test reset
                const observation = env.reset();
                if (observation && typeof observation === 'object') {
                    addTestResult('environment-tests', 'Reset environnement', 'OK');
                } else {
                    addTestResult('environment-tests', 'Reset environnement', 'FAIL', 'Observation invalide');
                }

                // Test step avec action simple
                const action = { mainThruster: 0.5, rotationInput: 0 };
                const result = env.step(action);
                
                if (result && typeof result.reward === 'number' && typeof result.done === 'boolean') {
                    addTestResult('environment-tests', 'Step environnement', 'OK', `R√©compense: ${result.reward}`);
                } else {
                    addTestResult('environment-tests', 'Step environnement', 'FAIL', 'R√©sultat invalide');
                }

            } catch (e) {
                addTestResult('environment-tests', 'Test HeadlessRocketEnvironment', 'FAIL', `Erreur: ${e.message}`);
            }
        }

        // Test 5: TrainingOrchestrator
        function testTrainingOrchestrator() {
            try {
                const eventBus = new EventBus();
                const orchestrator = new TrainingOrchestrator(eventBus);
                
                addTestResult('training-tests', 'Cr√©ation TrainingOrchestrator', 'OK');

                // Test configuration
                const config = orchestrator.getConfig();
                if (config && typeof config.maxEpisodes === 'number') {
                    addTestResult('training-tests', 'Configuration par d√©faut', 'OK', `Max √©pisodes: ${config.maxEpisodes}`);
                } else {
                    addTestResult('training-tests', 'Configuration par d√©faut', 'FAIL', 'Configuration invalide');
                }

                // Test m√©triques
                const metrics = orchestrator.getMetrics();
                if (metrics && typeof metrics.episode === 'number') {
                    addTestResult('training-tests', 'M√©triques initiales', 'OK');
                } else {
                    addTestResult('training-tests', 'M√©triques initiales', 'FAIL', 'M√©triques invalides');
                }

            } catch (e) {
                addTestResult('training-tests', 'Test TrainingOrchestrator', 'FAIL', `Erreur: ${e.message}`);
            }
        }

        // Test 6: Entra√Ænement rapide
        async function runQuickTrainingTest() {
            try {
                addTestResult('quick-training-tests', 'D√©marrage test entra√Ænement', 'PENDING', 'En cours...');
                
                const eventBus = new EventBus();
                const orchestrator = new TrainingOrchestrator(eventBus);
                
                // Configuration tr√®s r√©duite pour test rapide
                const quickConfig = {
                    maxEpisodes: 5,
                    maxStepsPerEpisode: 50,
                    learningRate: 0.01,
                    epsilon: 0.5,
                    batchSize: 8,
                    logInterval: 1,
                    evaluationInterval: 5,
                    checkpointInterval: 10
                };

                // √âcouter les √©v√©nements de progression
                let progressReceived = false;
                eventBus.subscribe(window.EVENTS.AI.TRAINING_PROGRESS, (data) => {
                    progressReceived = true;
                    addTestResult('quick-training-tests', `√âpisode ${data.episode}`, 'OK', 
                        `R√©compense: ${data.metrics.totalReward?.toFixed(2) || 'N/A'}`);
                });

                eventBus.subscribe(window.EVENTS.AI.TRAINING_COMPLETED, (stats) => {
                    addTestResult('quick-training-tests', 'Entra√Ænement termin√©', 'OK', 
                        `${stats.episodes} √©pisodes, ${stats.totalSteps} √©tapes`);
                });

                eventBus.subscribe(window.EVENTS.AI.TRAINING_ERROR, (data) => {
                    addTestResult('quick-training-tests', 'Erreur entra√Ænement', 'FAIL', data.error);
                });

                // D√©marrer l'entra√Ænement
                await orchestrator.startTraining(quickConfig);

                // V√©rifier que des √©v√©nements ont √©t√© re√ßus
                setTimeout(() => {
                    if (progressReceived) {
                        addTestResult('quick-training-tests', '√âv√©nements de progression', 'OK', '√âv√©nements re√ßus');
                    } else {
                        addTestResult('quick-training-tests', '√âv√©nements de progression', 'FAIL', 'Aucun √©v√©nement re√ßu');
                    }
                }, 1000);

            } catch (e) {
                addTestResult('quick-training-tests', 'Test entra√Ænement rapide', 'FAIL', `Erreur: ${e.message}`);
            }
        }

        // Lancer les tests automatiquement
        window.addEventListener('load', () => {
            setTimeout(() => {
                testDependencies();
                testConstants();
            }, 500);
        });
    </script>
</body>
</html> 